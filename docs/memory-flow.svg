<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 700">
  <defs>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;display=swap');
      .text { font-family: 'Inter', sans-serif; fill: #1e293b; }
      .title { font-size: 14px; font-weight: 600; }
      .subtitle { font-size: 11px; font-weight: 500; fill: #64748b; }
      .small { font-size: 10px; fill: #64748b; }
      .box { fill: #f8fafc; stroke: #e2e8f0; stroke-width: 1.5; rx: 8; }
      .box-primary { fill: #eff6ff; stroke: #3b82f6; stroke-width: 1.5; rx: 8; }
      .box-success { fill: #f0fdf4; stroke: #22c55e; stroke-width: 1.5; rx: 8; }
      .box-warning { fill: #fffbeb; stroke: #f59e0b; stroke-width: 1.5; rx: 8; }
      .box-purple { fill: #faf5ff; stroke: #a855f7; stroke-width: 1.5; rx: 8; }
      .arrow { stroke: #94a3b8; stroke-width: 2; fill: none; }
      .label { font-size: 10px; fill: #64748b; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#94a3b8" />
    </marker>
  </defs>

  <!-- Background -->
  <rect width="800" height="700" fill="#ffffff"/>

  <!-- Title -->
  <text x="400" y="30" text-anchor="middle" class="text title" font-size="18">记忆处理流程</text>

  <!-- User Request -->
  <rect x="300" y="50" width="200" height="40" class="box-primary"/>
  <text x="400" y="75" text-anchor="middle" class="text title">用户对话请求</text>

  <!-- Arrow down -->
  <line x1="400" y1="90" x2="400" y2="120" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Step 1: Search -->
  <rect x="150" y="120" width="500" height="140" class="box" stroke-dasharray="5,5"/>
  <text x="170" y="145" class="text title">1. 搜索相关记忆（混合检索）</text>

  <!-- Vector Search -->
  <rect x="180" y="160" width="140" height="80" class="box-purple"/>
  <text x="250" y="185" text-anchor="middle" class="text title">向量相似度搜索</text>
  <text x="250" y="203" text-anchor="middle" class="text subtitle">sqlite-vec KNN</text>
  <text x="250" y="218" text-anchor="middle" class="text small">归一化向量</text>
  <text x="250" y="232" text-anchor="middle" class="text small">余弦相似度</text>

  <!-- Keyword Search -->
  <rect x="340" y="160" width="140" height="80" class="box-purple"/>
  <text x="410" y="185" text-anchor="middle" class="text title">关键词搜索</text>
  <text x="410" y="203" text-anchor="middle" class="text subtitle">LIKE pattern</text>
  <text x="410" y="218" text-anchor="middle" class="text small">文本匹配</text>
  <text x="410" y="232" text-anchor="middle" class="text small">位置评分</text>

  <!-- Fusion -->
  <rect x="500" y="160" width="130" height="80" class="box-warning"/>
  <text x="565" y="185" text-anchor="middle" class="text title">结果融合</text>
  <text x="565" y="203" text-anchor="middle" class="text subtitle">70% + 30%</text>
  <text x="565" y="218" text-anchor="middle" class="text small">向量权重</text>
  <text x="565" y="232" text-anchor="middle" class="text small">关键词权重</text>

  <!-- Arrows for fusion -->
  <line x1="320" y1="200" x2="500" y2="200" class="arrow" marker-end="url(#arrowhead)"/>
  <line x1="480" y1="200" x2="500" y2="200" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Arrow down -->
  <line x1="400" y1="260" x2="400" y2="290" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Step 2: Add Context -->
  <rect x="200" y="290" width="400" height="50" class="box-success"/>
  <text x="400" y="312" text-anchor="middle" class="text title">2. 添加记忆上下文到 LLM 提示</text>
  <text x="400" y="330" text-anchor="middle" class="text subtitle">返回个性化响应</text>

  <!-- Arrow down -->
  <line x1="400" y1="340" x2="400" y2="380" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Step 3: Save Memory -->
  <rect x="100" y="380" width="600" height="280" class="box" stroke-dasharray="5,5"/>
  <text x="120" y="405" class="text title">3. 保存新对话到记忆</text>

  <!-- Chunking -->
  <rect x="130" y="420" width="120" height="60" class="box-purple"/>
  <text x="190" y="445" text-anchor="middle" class="text title">文本分块</text>
  <text x="190" y="463" text-anchor="middle" class="text small">400 tokens</text>
  <text x="190" y="475" text-anchor="middle" class="text small">80 overlap</text>

  <!-- Embedding -->
  <rect x="270" y="420" width="120" height="60" class="box-purple"/>
  <text x="330" y="445" text-anchor="middle" class="text title">生成嵌入</text>
  <text x="330" y="463" text-anchor="middle" class="text small">向量编码</text>
  <text x="330" y="475" text-anchor="middle" class="text small">归一化</text>

  <!-- Importance Scoring -->
  <rect x="410" y="420" width="160" height="60" class="box-warning"/>
  <text x="490" y="442" text-anchor="middle" class="text title">重要性评分</text>
  <text x="490" y="460" text-anchor="middle" class="text small">5维度加权</text>
  <text x="490" y="473" text-anchor="middle" class="text small">综合分数 0-1</text>

  <!-- Tier Assignment -->
  <rect x="590" y="420" width="90" height="60" class="box-success"/>
  <text x="635" y="442" text-anchor="middle" class="text title">分层</text>
  <text x="635" y="460" text-anchor="middle" class="text small">工作/长期</text>
  <text x="635" y="473" text-anchor="middle" class="text small">档案</text>

  <!-- Arrows -->
  <line x1="250" y1="450" x2="270" y2="450" class="arrow" marker-end="url(#arrowhead)"/>
  <line x1="390" y1="450" x2="410" y2="450" class="arrow" marker-end="url(#arrowhead)"/>
  <line x1="570" y1="450" x2="590" y2="450" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Scoring Details -->
  <rect x="130" y="500" width="550" height="70" class="box"/>
  <text x="405" y="525" text-anchor="middle" class="text subtitle">评分维度</text>

  <text x="150" y="545" class="text small">• 新颖性 (25%) - 与现有记忆的相似度</text>
  <text x="150" y="560" class="text small">• 情感强度 (15%) - 关键词分析</text>
  <text x="400" y="545" class="text small">• 用户反馈 (30%) - 访问次数 + 时间衰减</text>
  <text x="400" y="560" class="text small">• 访问频率 (20%) - 检索频率</text>
  <text x="600" y="545" class="text small">• 信息密度 (10%) - 实体数量</text>

  <!-- Tier Rules -->
  <rect x="130" y="585" width="550" height="65" class="box"/>
  <text x="405" y="610" text-anchor="middle" class="text subtitle">层级判定规则</text>

  <rect x="150" y="620" width="150" height="25" class="box-success" rx="4"/>
  <text x="225" y="637" text-anchor="middle" class="text small">≥0.6 → 长期记忆</text>

  <rect x="310" y="620" width="150" height="25" class="box-warning" rx="4"/>
  <text x="385" y="637" text-anchor="middle" class="text small">0.3-0.6 → 工作记忆</text>

  <rect x="470" y="620" width="150" height="25" class="box" rx="4"/>
  <text x="545" y="637" text-anchor="middle" class="text small">&lt;0.3 → 档案记忆</text>

  <!-- Final Arrow to Database -->
  <line x1="635" y1="480" x2="635" y2="500" class="arrow"/>
  <line x1="635" y1="500" x2="400" y2="500" class="arrow"/>
  <line x1="400" y1="500" x2="400" y2="570" class="arrow" marker-end="url(#arrowhead)"/>
</svg>
